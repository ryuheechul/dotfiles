%YAML 1.2
---
# copied from https://github.com/eugenesvk/sublime-KDL/blob/c65c12135e6cc604dc3ccf2878299c5a70f3bc57/KDL.sublime-syntax
name             : KDL
file_extensions  : [kdl]
scope            : source.kdl
version          : 2
# See Whitespace (Line breaking and non-Newline) at file end

# !sets don't allow whitespace even with (?x:), so watch out for [{{var}}] where var='(?x: abc)', 'x' will also be included
  # _digit _char = set-safe [{{var_s}}], i.e. contains only characters, no conditional matching groups
  # use syntax rules instead of variables that can't be recursive
  # lookaheads skip meta scopes, so might need to repeat them
# quote regexes with # : - { [ >
# Oniguruma regex engine features
  # rbuckton.github.io/regexp-features/engines/oniguruma.html
  # raw.githubusercontent.com/kkos/oniguruma/v6.9.1/doc/RE  6.8.0 2018/07/26 (not sure which version ST uses)
    # github.com/kkos/oniguruma/blob/master/doc/RE (latest)
# \k<> named group, while \g<> is recursion!
# include ignores meta patterns in the included contexts

# ident = identifier #ss#=set safe #ss!# set safe with exception
# _var = var rules can't be expressed within literal regexes, e.g., excluding keywords
variables:
  nodes:                    	'(?x: {{linespace_re}}*                                      	#
    (?##)                   	   ({{node}} {{nodes}}?)?                                    	#
    (?##)                   	      {{linespace_re}}*                                      	)' #
  node:                     	'(?x:                                                        	#
    (?##)                   	 (/\- {{node_space}}*)?                                      	# Slashdash comment
    (?##)                   	                       {{type}} ? {{ID}}                     	#
    (?##)                   	      ({{node_space}}+ {{node_prop_or_arg}} )*               	#
    (?##)                   	      ({{node_space}}* {{node_children}} {{ws}}*)?           	#
    (?##)                   	       {{node_space}}* {{node_terminator}}                   	)' #
  node_prop_or_arg:         	'(/\-{{node_space}}*)?({{prop}}|{{value}})'                  	#
  node_children:            	'(/\-{{node_space}}*)?{{{nodes}}}'                           	#
  node_space:               	'{{ws}}*{{escline}}{{ws}}*|{{ws}}+'                          	#
  node_sp_beg:              	'{{ws_beg}}|{{escline_beg}}'                                 	#
  line_sp_beg:              	'{{ws_beg}}|{{c_line_beg}}|{{nl_s}}'                         	#
  any_sp_t_beg:             	'{{node_sp_beg}}|{{node_term_beg}}'                          	#
  node_sp_end:              	'{{ws_end}}' #|{{escline_end}} âœ— needs previous line         	#
  pre_val:                  	'^|\=|\)|{{node_sp_end}}'                                    	# line begin^ as line-cont surrogate
  ws_beg:                   	'{{b_sp}}|{{comment_block_beg}}'                             	#
  ws_end:                   	'{{b_sp}}|{{comment_block_end}}'                             	#
  node_terminator:          	'{{single_line_comment}}|{{newline}}|;|{{eof}}'              	#
  node_term_beg:            	'{{c_line_beg}}|;|{{eof}}|{{nl_s}}'                          	#
  node_term_beg_no_nl:      	'{{c_line_beg}}|;|{{eof}}'                                   	#
  #                         	                                                             	#
  # bareID:                 	'(?!{{keyword}}[^{{charID}}]){{bareID_or_KW}}'               	#
  bareID_or_KW:             	'{{bareID_ex_dig_sign}}|{{bareID_ex_dig}}'                   	#
  bareID_ex_dig_sign:       	'{{charID_ex_dig_sign}}{{charID}}*'                          	# pre-sign: exclude digit/sign to avoid clashes
  bareID_ex_dig:            	'[+-](?:{{charID_ex_dig}}{{charID}}*)?'                      	# pos-sign: exclude digit only
  charID:                   	'[[{{unicode_char}}]&&[^{{charWS}}]&&[^{{charID_not}}]]'     	#
  charID_not:               	'[\/\\(){}<>;\[\]=,"]'                                       	#
  charWS:                   	'[{{nl_s}}{{b_sp}}]'                                         	#
  charID_rec:               	'{{charID}}(?!{{linespace_re}})'                             	# set-unsafe; includes recursion: linespace â†’ ws â†’ multi_line_comment â†’ commented_blockğŸ—˜
  charID_ex_dig:            	'[[{{charID}}]&&[^{{d_dec}}]]'                               	#
  charID_ex_dig_sign:       	'[[{{charID_ex_dig}}]&&[^+-]]'                               	#
  unicode_char:             	'[\x{0021}-\x{10FFFF}]'                                      	# invalid: â‰¤0x20 or >0x10FFF)
  keyword:                  	'{{boolean}}|{{nil}}'                                        	#
  prop:                     	'{{ID}}={{value}}'                                           	#
  prop_eq:                  	'({{b_sp}}?)({{b_sp}}*)(=)({{b_sp}}?)({{b_sp}}*)'            	#
  value:                    	'{{type}}?({{string}}|{{number}}|{{keyword}})'               	#
  type:                     	'\({{ID}}\)'                                                 	#
  escaped_string:           	'"{{character}}*"'                                           	#
  character:                	'\\{{escape}}|[^"]'                                          	#
  escape:                   	'{{escape_char}}|{{escape_unicode}}'                         	#
  escape_char:              	'["\\/bfnrt]'                                                	#
  escape_unicode:           	'u{{{d_hex}}{1,6}}'                                          	#
  d_bin:                    	'[0-1]'                                                      	#
  d_bin_:                   	'[0-1_]'                                                     	#
  d_oct:                    	'[0-7]'                                                      	#
  d_oct_:                   	'[0-7_]'                                                     	#
  d_dec:                    	'[0-9]'                                                      	#
  d_dec_:                   	'[0-9_]'                                                     	#
  d_hex:                    	'[0-9a-fA-F]'                                                	#
  d_hex_:                   	'[0-9a-fA-F_]'                                               	#
  #                         	                                                             	#
  boolean:                  	'(?:true|false)'                                             	# data type 1/4
  nil:                      	'(?:null)'                                                   	# data type 2/4
  string:                   	'{{raw_string}}|{{escaped_string}}'                          	# data type 3/4
  number:                   	'{{decimal}}|{{hex}}|{{octal}}|{{binary}}'                   	# data type 4/4
  #    â†“string              	                                                             	#
  raw_string:               	 '(r)(#+)?(\")([\S\s]*?)(\")(\2)'                            	#
  raw_string_re:            	 'r{{raw_string_hash_re}}'                                   	#ğŸ—˜
  raw_string_hash_re:       	'#{{raw_string_hash_re}}#|{{raw_string_quotes}}'             	#ğŸ—˜
  raw_string_quotes:        	'".*"'                                                       	#
  string_beg:               	'"|r#*"'                                                     	# or (?!r)"|r#*"
  string_end:               	'"#*'                                                        	# or (?!r)"|r#*"
  #    â†“number              	                                                             	#
  decimal:                  	      '([+-])?({{integer}})(\.{{integer}})?{{exponent}}?'    	#
  exponent:                 	'([eE])([+-])?({{integer}})'                                 	#
  integer:                  	'{{d_dec}}{{d_dec_}}*'                                       	# leading 0s are allowed
  #sign:                    	'[+-]'                                                  #ss# 	# using [+-] is cleaner than {{sign}}
  #                         	                                                             	#
  hex:                      	'([+-])?(0x)({{d_hex}}{{d_hex_}}*)'                          	#
  octal:                    	'([+-])?(0o)({{d_oct}}{{d_oct_}}*)'                          	#
  binary:                   	'([+-])?(0b)({{d_bin}}{{d_bin_}}*)'                          	#
  #                         	                                                             	#
  escline:                  	'\\{{ws}}*({{single_line_comment}}|{{nl_s}})'                	#
  escline_beg:              	'\\'                                                         	#
  linespace_re:             	'{{nl_s}}|{{ws}}|{{single_line_comment}}'                    	# set-unsafe; includes recursion: ws â†’ multi_line_comment â†’ commented_blockğŸ—˜
  char_linesp:              	'[{{nl_s}}{{b_sp}}{{c_beg}}]'                           #ss!#	# ex / but not precisely //
  newline:                  	'(?>\r\n?|[\x{A}\x{C}\x{85}\x{2028}\x{2029}])'               	# \R without \v
  nl_s:                     	'[\r\n\x{C}\x{85}\x{2028}\x{2029}]'                     #ss!#	# not precisely â¤âŠ
  ws:                       	'{{bom}}|{{u_sp}}|{{multi_line_comment}}'                    	#
  b_sp:                     	'[{{bom}}{{u_sp}}]'                                     #ss# 	#
  bom:                      	'[\x{FEFF}]'                                                 	#
  unicode_space:            	'[[\s]&&[^{{nl_s}}]]'                                        	#
  single_line_comment:      	'({{c_line_beg}})([^{{nl_s}}]*)({{c_line_end}})'             	#
  single_line_comment_no_nl:	'({{c_line_beg}})([^{{nl_s}}]*)'                             	#
  multi_line_comment:       	'{{comment_block_beg}}{{commented_block}}'                   	# set-unsafe; recursion: commented_blockğŸ—˜
  c_beg:                    	'/'                                                          	#
  c_slashdash:              	'/-'                                                         	#
  c_line_beg:               	'//'                                                         	#
  c_line_end:               	'{{nl_s}}|{{eof}}'                                           	#
  eof:                      	'$(?!{{nl_s}})'                                              	#
  eof_x:                    	'(?=[\S\s]{{eof}})' # when â†‘ bugs                            	#
  comment_block_beg:        	'/\*'                                                        	#
  comment_block_doc_beg:    	'{{comment_block_beg}}(!|\*(?!/))'                           	#
  commented_block:          	'\*/|({{multi_line_comment}}|\*|/|[^*/]+){{commented_block}}'	# !!! cant recurse vars, do via syntax
  comment_block_end:        	'\*/'                                                        	#
  comment_block_doc_end:    	'{{comment_block_end}}'                                      	#
  u_sp: '[\x{9}\x{20}\x{A0}\x{1680}\x{2000}\x{2001}\x{2002}\x{2003}\x{2004}\x{2005}\x{2006}\x{2007}\x{2008}\x{2009}\x{200A}\x{202F}\x{205F}\x{3000}]' #ss# #
  ID: '{{string}}|((?!({{keyword}})[^{{charID}}])({{bareID_ex_dig_sign}}|{{bareID_ex_dig}}))' # bugs as 'recursive' if replace inlined vars with the same combo var
  bareID:        '((?!({{keyword}})[^{{charID}}])({{bareID_ex_dig_sign}}|{{bareID_ex_dig}}))' # bugs as 'recursive' if replace inlined vars with the same combo var
  # â†‘ excludes keywords, but string would be a pain to style

contexts:
  # prototype:
    # - include: wss
    # - include: comment_blockâˆ¨doc
    # - meta_include_prototype: false
    # todo: bugs e.g. (a)/**/1 is a comment even if you exclude everywhere

  main:
    - meta_include_prototype: false
    - match : ''
      push  : #âœ—â°
      #- meta_scope        : dbgâœ—Â¹
      - include: nodes

  nodes: #âœ—â° â‰ˆ linespace* (node nodes?)? linespace*
    - include: linesp
    - include: â„-âˆ¨node
    - include: anyğŸ›‘ # todo disable? strict mode
    # - include: any-pop
  nodesâ„-: #âœ—â°
    - include: linesp
    - include: â„-âˆ¨nodeâ„-
    - include: anyğŸ›‘ # todo disable? strict mode
    # - include: any-pop

#â€”â€”â€” 0 Groups
  node-elements:          #âœ—Â²
    - match               : (?={{node_sp_beg}}) # mandatory whitespace
      push                : #âœ—Â³ push to require ws before each element
      #- meta_scope        : dbgâœ—Â³nodeâ argâˆ¨propâˆ¨child
      - include           : nodeâ s
      - match             : '({{c_slashdash}})'
        scope             : comment.line.slash-dash.kdl punctuation.definition.comment.begin.kdl
        pop               : 1
        set               :
        #- meta_scope      : dbgâœ—Â³nodeâ â„âˆ’argâˆ¨propâˆ¨child
        - include         : nodeâ s
        - include         : pop_preâ¤
        - include         : node_terminatorğŸ›‘3
        - include         : argâˆ¨propâ„-
        - include         : child_blockâ„-
        - include         : pop # todo not style /- empty via branches above â†‘
        # - include         : SğŸ›‘Â¹pre_sâˆ¨câˆ¨t
      - include           : argâˆ¨prop
      - include           : child_block
      - include           : node_terminator4  # ... but then an extra pop is needed
    - include             : child_block1
    - include             : node_terminator3
    - include             : SğŸ›‘Â¹pre_sâˆ¨câˆ¨t
    # - include: comments
    # - include: charğŸ†”Â¬
  node-elementsâ„-:        #âœ—Â²
    - match               : (?={{node_sp_beg}}) # mandatory whitespace
      push                : #âœ—Â³ push to require ws before each element
      #- meta_scope        : dbgâœ—Â³nodeâ _argâˆ¨propâˆ¨childâ„-
      - include           : nodeâ s
      - match             : '({{c_slashdash}})'
        scope             : comment.line.slash-dash.kdl punctuation.definition.comment.begin.kdl
        pop               : 1
        set               : # no terminator, /-; illegal
        #- meta_scope      : dbgâœ—nodeâ â„âˆ’argâˆ¨propâˆ¨childâ„âˆ’
        - include         : nodeâ s
        - include         : pop_preâ¤
        - include         : node_terminatorğŸ›‘3
        - include         : argâˆ¨propâ„-
        - include         : child_blockâ„-
        - include         : pop # todo not style /- empty via branches above â†‘

      - include           : argâˆ¨propâ„-
      - include           : child_blockâ„-
      - include           : node_terminator4â„-
    - include             : child_block1â„-
    - include             : node_terminator3â„-
    - include             : SğŸ›‘Â¹pre_sâˆ¨câˆ¨t

  string:
    - include: string-quoted-double
    - include: string-quoted-double-raw
  strings:
    - include: strings-quoted-double
    - include: strings-quoted-double-raw
  stringâ„-:
    - include: string-quoted-doubleâ„-
    - include: string-quoted-double-rawâ„-
  stringsâ„-:
    - include: strings-quoted-doubleâ„-
    - include: strings-quoted-double-rawâ„-
  number:
    - include: binÂ¦octÂ¦hex-partial
    - include: hexadecimal
    - include: octal
    - include: binary
    - include: intâˆ¨decâˆ¨float
  numberâ„-:
    - include: binÂ¦octÂ¦hexâ„-partial
    - include: hexadecimalâ„-
    - include: octalâ„-
    - include: binaryâ„-
    - include: intâˆ¨decâˆ¨floatâ„-
  comments:
    - include: comment_blockâˆ¨doc
    # - include: comment_slashdash
    - include: comment_line
  comment_blockâˆ¨doc:
    - include: comment_block_doc
    - include: comment_block
  keyword:
    - include: keyword-partial
    - include: boolean
    - include: nil
  keywordâ„-:
    - include: keyword-partialâ„-
    - include: booleanâ„-
    - include: nilâ„-
  keywordğŸ›‘:
    - include: booleanğŸ›‘
    - include: nullğŸ›‘
  keywordğŸ›‘â„-:
    - include: booleanğŸ›‘â„-
    - include: nullğŸ›‘â„-
  keyword-partial: # avoid red flashes with unfinished typing
    - include: true-partial
    - include: false-partial
    - include: null-partial
  keyword-partialâ„-:
    - include: true-partialâ„-
    - include: false-partialâ„-
    - include: null-partialâ„-



#â€”â€”â€” 1 Node: \- type
  â„-âˆ¨node:                #âœ—â° â‰ (/- node-space*)? type? identifier
    - match               : '{{c_slashdash}}'
      scope               : comment.line.slash-dash.kdl punctuation.definition.comment.begin.kdl
      pop                 : 1
      push                : # pop+push: match gets NO meta_scope of the popped context (â‰ˆlookahead)
      - meta_scope        : comment.block.slash-dash.kdl #âœ—â° # comment.line.slash-dash added last @content
      - include           : nodeâ 
      - include           : node_nameâ„-
    - include             : node_name
  â„-âˆ¨nodeâ„-:              #âœ—â°
    - match               : '{{c_slashdash}}'
      scope               : comment.line.slash-dash.kdl punctuation.definition.comment.begin.kdl
      pop                 : 1
      push                : # pop+push: match gets NO meta_scope of the popped context (â‰ˆlookahead)
      - meta_scope        : comment.block.slash-dash.kdl #âœ—â° # comment.line.slash-dash added last @content
      - include           : nodeâ 
      - include           : node_nameâ„-
    - include             : node_nameâ„-
  node_name:              #âœ—â°
    - match               : '(?=\()'
      push                :
      - meta_scope        : meta.node.kdl #âœ—Â¹node_name_t
      - include           : type-node
    - match               : '(?={{string_beg}}|{{bareID}})'
      push                :
      - meta_scope        : meta.node.kdl #âœ—Â¹node_name_s_b
      - include           : nodeID
  node_nameâ„-:            #âœ—â°
    - include             : line_continuationâ„-
    - match               : '(?=\()'
      push                :
      - meta_scope        : meta.node.kdl #âœ—Â¹node_nameâ„â€“_t
      - include           : type-nodeâ„-
    - match               : '(?={{string_beg}}|{{bareID}})'
      push                :
      - meta_scope        : meta.node.kdl #âœ—Â¹node_nameâ„â€“_s_b
      - include           : nodeIDâ„-

  type-node:              #âœ—Â¹
    - match               : \(
      scope               : punctuation.separator.annotation.begin.kdl
      push                : #âœ—Â²
      - meta_scope        : meta.annotation.kdl #âœ—Â²m
      - meta_content_scope: entity.name.type.kdl #âœ—Â²c
      - match             : '(?<=\()(\))|(\))'
        captures          :
          1:                invalid.illegal.muted.kdl #punctuation.separator.annotation.end.kdl invalid.illegal.position.kdl
          2:                punctuation.separator.annotation.end.kdl #âœ—typenode_close
        pop               : 2 # remove 1st annotation, 2 fixes a bug?
        set               : #âœ—Â¹ # push bugs even with pop, still get meta_content
        - include         : bspğŸ›‘Â¹s # type should be glued to its value
        - include         : nodeID
        - include         : charğŸ†”Â¬
        - include         : anyğŸ›‘s
      - include           : type-content-node
      - include           : typeğŸ›‘
  type-nodeâ„-:            #âœ—Â¹
    - match               : \(
      scope               : punctuation.separator.annotation.begin.kdl comment.line.slash-dash.kdl #âœ—typenodeâ„â€“open
      push                : #âœ—Â²
      - meta_scope        : meta.annotation.kdl #âœ—Â²m
      - meta_content_scope: entity.name.type.kdl #âœ—Â²c
      - match             : '(?<=\()(\))|(\))'
        captures          :
          1:                invalid.illegal.muted.kdl #punctuation.separator.annotation.end.kdl invalid.illegal.position.kdl
          2:                punctuation.separator.annotation.end.kdl comment.line.slash-dash.kdl #âœ—typenodeâ„â€“close
        pop               : 2 # remove 1st annotation, 2 fixes a bug?
        set               : #âœ—Â¹
        - include         : bspğŸ›‘Â¹s # type should be glued to its value
        - include         : nodeIDâ„-
        - include         : charğŸ†”Â¬
        - include         : anyğŸ›‘s
      - include           : type-content-nodeâ„-
      - include           : typeğŸ›‘

  type-content-node:      #âœ—Â²
    - include             : keywordğŸ›‘
    - match               : '(?={{string_beg}})' # string can't just use to ban "a""b"
      push                : #âœ—Â³
      # - meta_scope        : dbgtype-content-nodeâœ—Â³
      - include           : strings-quoted-double-raw-consecutiveğŸ›‘ # ..gs allows popping later on )
      - include           : strings-quoted-double-consecutiveğŸ›‘
      - include           : strings
      - include           : pop_preï¼‰ # remove â†‘
      - include           : anyğŸ›‘s
    - include             : IDs_bare
  type-content-nodeâ„-:
    - include             : keywordğŸ›‘â„-
    - match               : '(?={{string_beg}})' # string can't just use to ban "a""b"
      push                : #âœ—Â³
      # - meta_scope        : dbgtype-content-nodeâœ—Â³
      - include           : strings-quoted-double-raw-consecutiveğŸ›‘
      - include           : strings-quoted-double-consecutiveğŸ›‘
      - include           : stringsâ„-
      - include           : pop_preï¼‰ # remove â†‘
      - include           : anyğŸ›‘s
    - include             : IDs_bare



#â€”â€”â€” 2 Node Element: 1 Name
  nodeID:                 #âœ—Â¹
    - include             : keywordsğŸ›‘
    - match               : '(?={{string_beg}})'
      push                : #âœ—Â²
      - meta_scope        : entity.name.tag.node.kdl #âœ—Â²
      - include           : string-quoted-double-raw-consecutiveğŸ›‘3
      - include           : string-quoted-double-consecutiveğŸ›‘3
      - include           : strings
      - include           : node-elements
      - include           : node_terminator3
    - include             : bare-after-stringğŸ›‘
    - match               : '{{bareID}}'
      scope               : entity.name.tag.node.kdl
      push                : #âœ—Â²
      #- meta_scope        : dbgâœ—Â²_nodeIDâ†’node_elements
      - include           : node-elements
      - include           : node_terminator3
      - include           : SğŸ›‘s
  nodeIDâ„-:               #âœ—Â¹
    - include             : keywordsâ„-ğŸ›‘
    - match               : '(?={{string_beg}})'
      push                : #âœ—Â²
      - meta_scope        : entity.name.tag.node.kdl #âœ—Â²
      - include           : string-quoted-double-raw-consecutiveğŸ›‘3
      - include           : string-quoted-double-consecutiveğŸ›‘3
      - include           : stringsâ„-
      - include           : node-elementsâ„-
      - include           : node_terminator3â„-
    - include             : bare-after-stringğŸ›‘
    - match               : '{{bareID}}'
      scope               : entity.name.tag.node.kdl comment.line.slash-dash.kdl
      push                : #âœ—Â²
      #- meta_scope        : dbgâœ—Â²_nodeIDâ†’node-elementsâ„â€“
      - include           : node-elementsâ„-
      - include           : node_terminator3â„-
      - include           : SğŸ›‘s

#â€”â€”â€” 2 Node Element: 2 Argument or 3 Property
  argâˆ¨prop:               #âœ—Â³
    # - include           : nodeâ 
    - include             : arg_typed
    - include             : arg_untypedâˆ¨prop
  argâˆ¨propâ„-:             #âœ—Â³
    # - include           : nodeâ â„-
    - include             : arg_typedâ„-
    - include             : arg_untypedâˆ¨propâ„-

  arg_untypedâˆ¨prop:       #âœ—Â³
    - match               : '(?={{string_beg}})'
      branch_point        : â¸™1â€œargâˆ¨propâ€
      branch              : #âœ—â´â¸™
        - â€œargâ€-â¸™1
        - â€œâš¿â€â‚Œv-â¸™1
    - match               : '(?={{charID}})'
      branch_point        : â¸™2argâˆ¨prop
      branch              : #âœ—â´â¸™
        - arg-â¸™2
        - âš¿â‚Œv-â¸™2
  arg_untypedâˆ¨propâ„-:     #âœ—Â³
    - match               : '(?={{string_beg}})'
      branch_point        : â¸™1â€œargâˆ¨propâ€â„-
      branch              : #âœ—â´â¸™
        - â€œargâ€â„-â¸™1
        - â€œâš¿â€â‚Œvâ„-â¸™1
    - match               : '(?={{charID}})'
      branch_point        : â¸™2argâˆ¨propâ„-
      branch              : #âœ—â´â¸™
        - argâ„-â¸™2
        - âš¿â‚Œvâ„-â¸™2

#â€”â€”â€” 2 Node Element: 2 Argument
  â€œargâ€-â¸™1:               #âœ—â´
    - meta_scope          : meta.argument.value.kdl meta.mapping.value.kdl #âœ—â´â€œargâ€â¸™1
    - include             : â€œargâ€
    - include             : â€œargâ€ğŸ›‘
    - include             : popâ¸™
  â€œargâ€â„-â¸™1:               #âœ—â´
    - meta_scope          : meta.argument.value.kdl meta.mapping.value.kdl #âœ—â´â€œargâ€â„â¸™1
    - include             : â€œargâ€â„-
    - include             : â€œargâ€ğŸ›‘
    - include             : popâ¸™
  arg-â¸™2:                 #âœ—â´
    - meta_scope          : meta.argument.value.kdl meta.mapping.value.kdl #âœ—â´argâ¸™2
    - match               : '{{prop_eq}}'
      fail                : â¸™2argâˆ¨prop
    - match               : '(\S*)(?==)'
      fail                : â¸™2argâˆ¨prop
    - include             : value
    - include             : valueğŸ›‘
    - include             : pop_preâ¤
    - include             : popâ¸™
  argâ„-â¸™2:                #âœ—â´
    - meta_scope          : meta.argument.value.kdl meta.mapping.value.kdl #âœ—â´argâ„_â¸™2
    - match               : '{{prop_eq}}'
      fail                : â¸™2argâˆ¨propâ„-
    - match               : '(\S*)(?==)'
      fail                : â¸™2argâˆ¨propâ„-
    - include             : valueâ„-
    - include             : valueğŸ›‘
    - include             : pop_preâ¤
    - include             : popâ¸™

  arg_typed:              #âœ—Â³
    - match               : (?=\()
      set                 :
      - meta_scope        : meta.argument.value.kdl meta.mapping.value.kdl #âœ—Â³typed
      - include           : type-value
  arg_typedâ„-:            #âœ—Â³
    - match               : (?=\()
      set                 :
      - meta_scope        : meta.argument.value.kdl meta.mapping.value.kdl #âœ—Â³typedâ„-
      - include           : type-valueâ„-
  â€œargâ€:                  #âœ—â´
    # - include             : string  # can't use as is since branch check comes after we're inside a string!
    - match               : '(?={{string_beg}})'
      push                : #âœ—âµ
      # - meta_scope        : dbgâ€œargâ€âœ—âµ
      - include           : string-quoted-double-raw-consecutiveğŸ›‘3
      - include           : string-quoted-double-consecutiveğŸ›‘3
      - include           : strings
      - match             : '{{prop_eq}}'
        fail              : â¸™1â€œargâˆ¨propâ€
      - include           : pop3  # Â¹arg_untypedâˆ¨prop branch Â²â†‘ 3 exit
  â€œargâ€â„-:                #âœ—â´
    - match               : '(?={{string_beg}})'
      push                : #âœ—âµ
      # - meta_scope        : dbgâ€œargâ€âœ—âµ
      - include           : string-quoted-double-raw-consecutiveğŸ›‘3
      - include           : string-quoted-double-consecutiveğŸ›‘3
      - include           : stringsâ„-
      - match             : '{{prop_eq}}'
        fail              : â¸™1â€œargâˆ¨propâ€â„-
      - include           : pop3  # Â¹arg_untypedâˆ¨prop branch Â²â†‘ 3 exit

  # arg:                    #âœ—â´
  #   - include             : type-value
  #   - include             : value
  #   - include             : valueğŸ›‘
  # argâ„-:                  #âœ—â´
  #   - include             : type-valueâ„-
  #   - include             : valueâ„-
  #   - include             : valueğŸ›‘

  value:                  #âœ—â´
    - include             : keyword
    - include             : string
    - include             : number
  valueâ„-:                #âœ—â´
    - include             : keywordâ„-
    - include             : stringâ„-
    - include             : numberâ„-
  valğŸ›‘: # todo: combine?
    - include             : pop2_preâ 
    - include             : pop2_preâ¤
    - include             : pop2_pre-term
    # - include             : pop2_pre-str
    # - include             : charğŸ†”Â¬
    # - include             : pop_preğŸ†”Â¬  # let previous layers deal with invalid chars
    - include             : chğŸ›‘preâ    # todo: or just scrap illegals? let unstyled content be the indicator
  valueğŸ›‘:
    - include             : valğŸ›‘
    - include             : chğŸ›‘pre_term
    - include             : chğŸ›‘pre-str
  â€œargâ€ğŸ›‘:
    - include             : valğŸ›‘
    - include             : SğŸ›‘preâ¤

#â€”â€”â€” 2 Node Element: 3 Property
  âš¿â‚Œv-â¸™2:                 #âœ—â´
    - meta_scope          : meta.property.kdl #âœ—â´âš¿â‚Œvâ¸™
    - include             : âš¿
  âš¿â‚Œvâ„-â¸™2:                #âœ—â´
    - meta_scope          : meta.property.kdl #âœ—â´âš¿â‚Œvâ„â€“â¸™
    - include             : âš¿â„-
  âš¿:                      #âœ—â´
    - include             : keywordğŸ›‘
    - match               : '({{charID}}+)'
      scope               : entity.other.attribute-name.kdl
      pop                 : 1 # â†‘â¸™
      push                :
        - meta_scope      : meta.property.name.kdl meta.mapping.key.kdl #âœ—â´
        - include         : propertyâ‚Œ
        - include         : pop_pre-term # unblock errors from spoiling the whole line
  âš¿â„-:                    #âœ—â´
    - include             : keywordğŸ›‘â„-
    - match               : '({{charID}}+)'
      scope               : entity.other.attribute-name.kdl comment.line.slash-dash.kdl
      pop                 : 1 # â†‘â¸™
      set                 :
        - meta_scope      : meta.property.name.kdl meta.mapping.key.kdl #âœ—â´
        - include         : propertyâ‚Œâ„-
        - include         : pop_pre-term

  â€œâš¿â€â‚Œv-â¸™1:
    - meta_scope          : meta.property.name.kdl meta.mapping.key.kdl entity.other.attribute-name.kdl
    - include             : â€œâš¿â€
  â€œâš¿â€â‚Œvâ„-â¸™1:
    - meta_scope          : meta.property.name.kdl meta.mapping.key.kdl entity.other.attribute-name.kdl comment.line.slash-dash.kdl
    - include             : â€œâš¿â€â„-
  â€œâš¿â€:
    - include             : strings # allows â†“ check to go through while 2nd consecutive string not possible since it'll be treated as a second argument and there is a condition that errors that
    - include             : propertyâ‚Œ
  â€œâš¿â€â„-:
    - include             : stringsâ„-
    - include             : propertyâ‚Œâ„-
  propertyâ‚Œ:              #âœ—â´
    - match               : '{{prop_eq}}'
      captures            :
        1:                  invalid.illegal.position.kdl
        2:                  invalid.illegal.muted.position.kdl
        3:                  meta.property.separator.kdl meta.mapping.separator.kdl punctuation.separator.key-value.kdl
        4:                  invalid.illegal.position.kdl
        5:                  invalid.illegal.muted.position.kdl
      pop                 : 1
      push                : property-value # todo: set bugs to clear
  propertyâ‚Œâ„-:            #âœ—â´
    - match               : '{{prop_eq}}'
      captures            :
        1:                  invalid.illegal.position.kdl
        2:                  invalid.illegal.muted.position.kdl
        3:                  meta.property.separator.kdl meta.mapping.separator.kdl punctuation.separator.key-value.kdl comment.line.slash-dash.kdl
        4:                  invalid.illegal.position.kdl
        5:                  invalid.illegal.muted.position.kdl
      pop                 : 1
      push                : property-valueâ„- # todo: set bugs to clear
  property-value:         #âœ—â´
    # - meta_scope          : # gets misapplied to =
    # - meta_content_scope  : # gets miremoved from some values that pop immediately like boolean #meta.property.value.kdl meta.mapping.value.kdl âœ—â´
    - include             : comments
    - match               : (?=\()
      pop                 : 2 # â†‘â¸™ to reach Â³ like arg_typed
      push                : #âœ—Â³
      - meta_scope        : meta.property.value.kdl meta.mapping.value.kdl #âœ—Â³prop_val_typ
      - include           : type-value
    - match               : (?!\() # required to apply proper context to value
      set                 : #âœ—â´
      - meta_scope        : meta.property.value.kdl meta.mapping.value.kdl #âœ—â´prop_val_untyp
      - include           : value
      - include           : valueğŸ›‘
    - include             : propertyğŸ›‘
  property-valueâ„-:       # âœ—â´
    - meta_content_scope  : meta.property.value.kdl meta.mapping.value.kdl #âœ—â´
    - include             : commentsâ„-
    - match               : (?=\()
      pop                 : 2 # âš¿â‚Œvâ„-â¸™2 to reach Â³ like arg_typedâ„-
      push                : #âœ—Â³
      - meta_scope        : meta.property.value.kdl meta.mapping.value.kdl #âœ—Â³propâ„â€“_typ_val
      - include           : type-valueâ„-
    - match               : (?!\() # required to apply proper context to value
      set                 : #âœ—â´
      - meta_scope        : meta.property.value.kdl meta.mapping.value.kdl #âœ—â´propâ„â€“_val_untyp
      - include           : valueâ„-
      - include           : valueğŸ›‘
    - include             : propertyğŸ›‘
  propertyğŸ›‘:
      - include           : pop_preâ 
      - include           : pop_preâ¤
      - include           : pop_preğŸ†”Â¬     # let previous layers deal with invalid chars
      - include           : chğŸ›‘preâ  # todo: or just scrap illegals? let unstyled content be the indicator
      - include           : SğŸ›‘preâ¤
      - include           : SğŸ›‘s

#â€”â€”â€” Type-values
  type-value:             #âœ—Â³
    - match               : \(
      scope               : punctuation.separator.annotation.begin.kdl
      push                : #âœ—â´
      - meta_scope        : meta.annotation.kdl #âœ—â´type_value
      - meta_content_scope: entity.name.type.kdl
      - match             : '(?<=\()(\))|(\))'
        captures          :
          1:                invalid.illegal.muted.kdl #punctuation.separator.annotation.end.kdl invalid.illegal.position.kdl
          2:                punctuation.separator.annotation.end.kdl
        pop               : 1 # remove â†‘annotation
        set               : # push bugs even with pop, still get meta_content
        - include         : bspğŸ›‘Â¹s # type should be glued to its value
        - include         : value
        - include         : valueğŸ›‘
        - include         : pop2_pre-term # todo: sort which are best
        - include         : anyğŸ›‘s
      - include           : type-name
      - include           : typeğŸ›‘
  type-valueâ„-:           #âœ—Â³
    - match               : \(
      scope               : punctuation.separator.annotation.begin.kdl comment.line.slash-dash.kdl #âœ—typeargâ„-
      push                : #âœ—â´
      - meta_scope        : meta.annotation.kdl #âœ—â´type-valueâ„â€“
      - meta_content_scope: entity.name.type.kdl comment.line.slash-dash.kdl
      - match             : '(?<=\()(\))|(\))'
        captures          :
          1:                invalid.illegal.muted.kdl #punctuation.separator.annotation.end.kdl invalid.illegal.position.kdl
          2:                punctuation.separator.annotation.end.kdl comment.line.slash-dash.kdl
        pop               : 1 # remove â†‘annotation
        set               : # push bugs even with pop, still get meta_content
        - include         : sğŸ›‘Â¹s
        - include         : valueâ„-
        - include         : valueğŸ›‘
        - include         : anyğŸ›‘s
      - include           : type-name
      - include           : typeğŸ›‘

  type-name:              #âœ—â´ see type-content-node
    - include             : keywordğŸ›‘
    - match               : '(?={{string_beg}})'
      push                : #âœ—âµ
      # - meta_scope        : dbgtype-nameâœ—âµ
      - include           : strings-quoted-double-raw-consecutiveğŸ›‘
      - include           : strings-quoted-double-consecutiveğŸ›‘
      - include           : strings
      - include           : pop_preï¼‰ # remove â†‘
      - include           : anyğŸ›‘s
    - include             : IDs_bare
  type-nameâ„-:
    - include             : keywordğŸ›‘â„-
    - match               : '(?={{string_beg}})'
      push                : #âœ—âµ
      # - meta_scope        : dbgtype-nameâ„â€“âœ—âµ
      - include           : strings-quoted-double-raw-consecutiveğŸ›‘
      - include           : strings-quoted-double-consecutiveğŸ›‘
      - include           : stringsâ„
      - include           : pop_preï¼‰ # remove â†‘
      - include           : anyğŸ›‘s
    - include             : IDs_bare
  # type-content: # fails due to the need to mandate 1value
    # - include             : keywordğŸ›‘
    # - include             : string
    # - include             : IDs_bare
  # type-contentâ„-:
  #   - include             : keywordğŸ›‘â„-
  #   - include             : stringâ„-
  #   - include             : IDs_bare
  typeğŸ›‘:
    - include             : charğŸ†”Â¬
    - include             : sğŸ›‘s
    - include             : SğŸ›‘s




  IDs_bare:
    - match               : '({{bareID}})'
  ID_bare:
    - match               : '({{bareID}})'
      pop                 : 1

#â€”â€”â€” Values - Keywords
  boolean:
    - match               : \b(true|false)\b
      scope               : keyword.other.kdl constant.language.boolean.kdl
      pop                 : 2
  booleanâ„-:
    - match               : \b(true|false)\b
      scope               : keyword.other.kdl constant.language.boolean.kdl comment.line.slash-dash.kdl
      pop                 : 2
  nil:
    - match               : '\b(null)\b'
      scope               : keyword.other.kdl constant.language.null.kdl
      pop                 : 2
  nilâ„-:
    - match               : '\b(null)\b'
      scope               : keyword.other.kdl constant.language.null.kdl comment.line.slash-dash.kdl
      pop                 : 2

  # before     sp begin
  # after  = ) sp end (though can't detect line continuation, add that condition within line cont rule)
  true-partial: #\b bugs with n t|x
    - match               : '(?<={{pre_val}})(t|tr|tru)(?={{any_sp_t_beg}})'
      #scope               : dbgâœ—true_partial punctuation.separator
      pop                 : 2
  true-partialâ„-:
    - match               : '(?<={{pre_val}})(t|tr|tru)(?={{any_sp_t_beg}})'
      scope               : comment.line.slash-dash.kdl
      pop                 : 2
  false-partial:
    - match               : '(?<={{pre_val}})(f|fa|fal|fals)(?={{any_sp_t_beg}})'
      #scope               : dbgâœ—false_partial entity.other.attribute-name.kdl
      pop                 : 2
  false-partialâ„-:
    - match               : '(?<={{pre_val}})(f|fa|fal|fals)(?={{any_sp_t_beg}})'
      scope               : comment.line.slash-dash.kdl
      pop                 : 2
  null-partial:
    - match               : '(?<={{pre_val}})(n|nu|nul)(?={{any_sp_t_beg}})'
      pop                 : 2
  null-partialâ„-:
    - match               : '(?<={{pre_val}})(n|nu|nul)(?={{any_sp_t_beg}})'
      scope               : comment.line.slash-dash.kdl
      pop                 : 2

  booleanğŸ›‘:
    - match               : '(true|false)(?=[^{{charID}}])'
      scope               : keyword.other.kdl constant.language.boolean.kdl invalid.illegal.position.kdl
  booleanğŸ›‘â„-:
    - match               : '(true|false)(?=[^{{charID}}])'
      scope               : keyword.other.kdl constant.language.boolean.kdl invalid.illegal.position.kdl comment.line.slash-dash.kdl
  nullğŸ›‘:
    - match               : '(null)(?=[^{{charID}}])'
      scope               : keyword.other.kdl constant.language.null.kdl invalid.illegal.position.kdl
  nullğŸ›‘â„-:
    - match               : '(null)(?=[^{{charID}}])'
      scope               : keyword.other.kdl constant.language.null.kdl invalid.illegal.position.kdl comment.line.slash-dash.kdl


#â€”â€”â€” Values - Strings
  string-quoted-double:
    - match               : '"'
      scope               : punctuation.definition.string.begin.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.kdl
      - match             : '"'
        scope             : punctuation.definition.string.end.kdl
        pop               : 3
      - include           : char-escaped
  string-quoted-doubleâ„-:
    - match               : '"'
      scope               : punctuation.definition.string.begin.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.kdl
      - meta_content_scope: comment.line.slash-dash.kdl
      - match             : '"'
        scope             : punctuation.definition.string.end.kdl comment.line.slash-dash.kdl
        pop               : 3
      - include           : char-escapedâ„-
  strings-quoted-double:
    - match               : '"'
      scope               : punctuation.definition.string.begin.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.kdl
      - match             : '"'
        scope             : punctuation.definition.string.end.kdl
        pop               : 1
      - include           : char-escaped
  strings-quoted-doubleâ„-:
    - match               : '"'
      scope               : punctuation.definition.string.begin.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.kdl
      - meta_content_scope: comment.line.slash-dash.kdl
      - match             : '"'
        scope             : punctuation.definition.string.end.kdl comment.line.slash-dash.kdl
        pop               : 1
      - include           : char-escapedâ„-
  char-escaped:
    - match               : '(\\)(({{escape_char}})|({{escape_unicode}}))'
      captures            :
        1:                 constant.character.escape.kdl
        3:                 constant.character.escape.kdl
        4:                 constant.character.escape.unicode.16-bit-hex.kdl
  char-escapedâ„-:
    - match               : '(\\)(({{escape_char}})|({{escape_unicode}}))'
      captures            :
        1:                 constant.character.escape.kdl comment.line.slash-dash.kdl
        3:                 constant.character.escape.kdl comment.line.slash-dash.kdl
        4:                 constant.character.escape.unicode.16-bit-hex.kdl comment.line.slash-dash.kdl
  string-quoted-double-raw:
    - match               : '(r)(#*)(")'
      captures            :
        1:                 storage.type.string.kdl
        2:                 punctuation.definition.string.begin.kdl
        3:                 punctuation.definition.string.begin.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.raw.kdl
      - match             : '"\2' # â†‘match (#*)
        scope             : punctuation.definition.string.end.kdl
        pop               : 3
  string-quoted-double-rawâ„-:
    - match               : '(r)(#*)(")'
      captures            :
        1:                 storage.type.string.kdl comment.line.slash-dash.kdl
        2:                 punctuation.definition.string.begin.kdl comment.line.slash-dash.kdl
        3:                 punctuation.definition.string.begin.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.raw.kdl
      - meta_content_scope: comment.line.slash-dash.kdl
      - match             : '"\2' # â†‘match (#*)
        scope             : punctuation.definition.string.end.kdl comment.line.slash-dash.kdl
        pop               : 3
  strings-quoted-double-raw:
    - match               : '(r)(#*)(")'
      captures            :
        1:                 storage.type.string.kdl
        2:                 punctuation.definition.string.begin.kdl
        3:                 punctuation.definition.string.begin.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.raw.kdl
      - match             : '"\2' # â†‘match (#*)
        scope             : punctuation.definition.string.end.kdl
        pop               : 1
  strings-quoted-double-rawâ„-:
    - match               : '(r)(#*)(")'
      captures            :
        1:                 storage.type.string.kdl comment.line.slash-dash.kdl
        2:                 punctuation.definition.string.begin.kdl comment.line.slash-dash.kdl
        3:                 punctuation.definition.string.begin.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : meta.string.kdl string.quoted.double.raw.kdl
      - meta_content_scope: comment.line.slash-dash.kdl
      - match             : '"\2' # â†‘match (#*)
        scope             : punctuation.definition.string.end.kdl comment.line.slash-dash.kdl
        pop               : 1
  strings-quoted-double-consecutiveğŸ›‘: #
    - match               : '((?<=#)|(?<="))(")([^"]*")'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€â€œâ€s
        3:                 invalid.illegal.muted.position.kdl #âœ—â€â€œâ€s
    - match               : '((?<=#)|(?<="))(")([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€â€œs
        3:                 invalid.illegal.muted.position.kdl #âœ—â€â€œs
  string-quoted-double-consecutiveğŸ›‘3: #
    - match               : '((?<=#)|(?<="))(")([^"]*")'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€â€œâ€3
        3:                 invalid.illegal.muted.position.kdl #âœ—â€â€œâ€3
      push                :
      - include           : pop3
    - match               : '((?<=#)|(?<="))(")([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€â€œ3
        3:                 invalid.illegal.muted.position.kdl #âœ—â€â€œ3
      push                :
      - include           : pop3
  string-quoted-double-consecutiveğŸ›‘4:
    - match               : '((?<=#)|(?<="))(")([^"]*")'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€â€œâ€4
        3:                 invalid.illegal.muted.position.kdl #âœ—â€â€œâ€4
      push                :
      - include           : pop4
    - match               : '((?<=#)|(?<="))(")([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€â€œ4
        3:                 invalid.illegal.muted.position.kdl #âœ—â€â€œ4
      push                :
      - include           : pop4
  strings-quoted-double-raw-consecutiveğŸ›‘:
    - match               : '((?<=#)|(?<="))(r)((?<h>#*)\")([\S\s]*?)(\"\k<h>)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€râ€œâ€s
        3:                 invalid.illegal.position.kdl #âœ—â€râ€œâ€s
        5:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œâ€s
        6:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œâ€s
    - match               : '((?<=#)|(?<="))(r)(#*)(")([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€râ€œs
        3:                 invalid.illegal.position.kdl #âœ—â€râ€œs
        4:                 invalid.illegal.position.kdl #âœ—â€râ€œs
        5:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œs
  string-quoted-double-raw-consecutiveğŸ›‘3:
    - match               : '((?<=#)|(?<="))(r)((?<h>#*)\")([\S\s]*?)(\"\k<h>)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€râ€œâ€3
        3:                 invalid.illegal.position.kdl #âœ—â€râ€œâ€3
        5:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œâ€3
        6:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œâ€3
      push                :
      - include           : pop3
    - match               : '((?<=#)|(?<="))(r)(#*)(")([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€râ€œ3
        3:                 invalid.illegal.position.kdl #âœ—â€râ€œ3
        4:                 invalid.illegal.position.kdl #âœ—â€râ€œ3
        5:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œ3
      push                :
      - include           : pop3
  string-quoted-double-raw-consecutiveğŸ›‘4:
    - match               : '((?<=#)|(?<="))(r)((?<h>#*)\")([\S\s]*?)(\"\k<h>)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€râ€œâ€4
        3:                 invalid.illegal.position.kdl #âœ—â€râ€œâ€4
        5:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œâ€4
        6:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œâ€4
      push                :
      - include           : pop4
    - match               : '((?<=#)|(?<="))(r)(#*)(")([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€râ€œ4
        3:                 invalid.illegal.position.kdl #âœ—â€râ€œ4
        4:                 invalid.illegal.position.kdl #âœ—â€râ€œ4
        5:                 invalid.illegal.muted.position.kdl #âœ—â€râ€œ4
      push                :
      - include           : pop4
  bare-after-stringğŸ›‘: #
    - match               : '((?<=#)|(?<="))({{bareID}})([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€bare
        6:                 invalid.illegal.muted.position.kdl #âœ—â€bare
      push                :
      - include           : pop3
  bare-after-stringğŸ›‘4:
    - match               : '((?<=#)|(?<="))({{bareID}})([{{b_sp}}\S]*)'
      captures            :
        2:                 invalid.illegal.position.kdl #âœ—â€bare
        6:                 invalid.illegal.muted.position.kdl #âœ—â€bare
      push                :
      - include           : pop4


#â€”â€”â€” Values - Numbers
  intâˆ¨decâˆ¨float:
    - match               : '([+-])?([0-9])' # leading zeros are allowed
      captures            :
        1:                  keyword.operator.arithmetic.kdl
      branch_point        : â¸™intâˆ¨decâˆ¨float
      branch              :
        - integerâ¸™        # Integer literal
        - decimalâ¸™        # Floating point literal (fraction)
        - floatâ¸™          # Floating point literal (exponent)
  intâˆ¨decâˆ¨floatâ„-:
    - match               : '([+-])?([0-9])' # leading zeros are allowed
      captures            :
        1:                  keyword.operator.arithmetic.kdl comment.line.slash-dash.kdl
        2:                  comment.line.slash-dash.kdl
      branch_point        : â¸™intâˆ¨decâˆ¨floatâ„-
      branch              :
        - integerâ„-â¸™
        - decimalâ„-â¸™
        - floatâ„-â¸™
  failâ¸™intâˆ¨decâˆ¨float-.:
    - match               : '\.'
      fail                : â¸™intâˆ¨decâˆ¨float
  failâ¸™intâˆ¨decâˆ¨floatâ„-.:
    - match               : '\.'
      fail                : â¸™intâˆ¨decâˆ¨floatâ„-
  failâ¸™intâˆ¨decâˆ¨float-â„¯:
    - match               : '[eE]'
      fail                : â¸™intâˆ¨decâˆ¨float
  failâ¸™intâˆ¨decâˆ¨floatâ„-â„¯:
    - match               : '[eE]'
      fail                : â¸™intâˆ¨decâˆ¨floatâ„-
  integerâ¸™:
    - meta_scope          : constant.numeric.value.kdl constant.numeric.integer.kdl
    - include             : failâ¸™intâˆ¨decâˆ¨float-.
    - include             : failâ¸™intâˆ¨decâˆ¨float-â„¯
    - include             : digitâ‚â‚€_
    - include             : pop3â¸™
  integerâ„-â¸™:
    - meta_scope          : constant.numeric.value.kdl constant.numeric.integer.kdl
    - include             : failâ¸™intâˆ¨decâˆ¨floatâ„-.
    - include             : failâ¸™intâˆ¨decâˆ¨floatâ„-â„¯
    - include             : digitâ‚â‚€_â„-
    - include             : pop3â¸™
  decimalâ¸™:                                       # Floating point literal (fraction)
    - meta_scope          : constant.numeric.value.kdl constant.numeric.decimal.kdl
    - include             : failâ¸™intâˆ¨decâˆ¨float-â„¯
    - include             : digitâ‚â‚€_
    - match               : '(\.)'
      scope               : punctuation.separator.decimal.kdl
      push                :
      - include           : failâ¸™intâˆ¨decâˆ¨float-â„¯
      - include           : digitâ‚â‚€_
      - include           : pop4
    - include             : pop3â¸™
  decimalâ„-â¸™:
    - meta_scope          : constant.numeric.value.kdl constant.numeric.decimal.kdl
    - include             : failâ¸™intâˆ¨decâˆ¨floatâ„-â„¯
    - include             : digitâ‚â‚€_â„-
    - match               : '(\.)'
      scope               : punctuation.separator.decimal.kdl comment.line.slash-dash.kdl
      push                :
      - include           : failâ¸™intâˆ¨decâˆ¨floatâ„-â„¯
      - include           : digitâ‚â‚€_â„-
      - include           : pop4
    - include             : pop3â¸™
  floatâ¸™:                                         # Floating point literal (exponent)
    - meta_scope          : constant.numeric.value.kdl constant.numeric.float.kdl constant.numeric.significand.kdl
    - include             : digitâ‚â‚€_
    - include             : floatï¼
    - include             : floatâ„¯partial
    - include             : floatâ„¯
    - include             : pop3â¸™
  floatâ„-â¸™:
    - meta_scope          : constant.numeric.value.kdl constant.numeric.float.kdl constant.numeric.significand.kdl
    - include             : digitâ‚â‚€_â„-
    - include             : floatï¼â„-
    - include             : floatâ„¯â„-partial
    - include             : floatâ„¯â„-
    - include             : pop3â¸™
  floatï¼:
    - match               : '(\.)'
      scope               : punctuation.separator.decimal.kdl
      push                :
      - include           : digitâ‚â‚€_
      - include           : pop
  floatï¼â„-:
    - match               : '(\.)'
      scope               : punctuation.separator.decimal.kdl comment.line.slash-dash.kdl
      push                :
      - include           : digitâ‚â‚€_â„-
      - include           : pop
  floatâ„¯partial:
    - match               : '([eE])([+-])?(?={{nl_s}})'
      captures            :
        1:                  punctuation.separator.exponent.kdl
        2:                  keyword.operator.arithmetic.kdl
      push                :
      - clear_scopes      : 1 # clear previous meta scope significand
      - meta_scope        : constant.numeric.exponent.kdl
      - include           : pop4
  floatâ„¯â„-partial:
    - match               : '([eE])([+-])?(?={{nl_s}})'
      captures            :
        1:                  punctuation.separator.exponent.kdl comment.line.slash-dash.kdl
        2:                  keyword.operator.arithmetic.kdl comment.line.slash-dash.kdl
      push                :
      - clear_scopes      : 1 # clear previous meta scope significand
      - meta_scope        : constant.numeric.exponent.kdl
      - include           : pop4
  floatâ„¯:
    - match               : '([eE])([+-])?([0-9])'
      captures            :
        1:                  punctuation.separator.exponent.kdl
        2:                  keyword.operator.arithmetic.kdl
      push                :
      - clear_scopes      : 1 # clear previous meta scope significand
      - meta_scope        : constant.numeric.exponent.kdl
      - include           : digitâ‚â‚€_
      - include           : pop4
  floatâ„¯â„-:
    - match               : '([eE])([+-])?([0-9])'
      captures            :
        1:                  punctuation.separator.exponent.kdl comment.line.slash-dash.kdl
        2:                  keyword.operator.arithmetic.kdl comment.line.slash-dash.kdl
      push                :
      - clear_scopes      : 1 # clear previous meta scope significand
      - meta_scope        : constant.numeric.exponent.kdl
      - include           : digitâ‚â‚€_â„-
      - include           : pop4

  binary:                                         # Integer literal (binary)
    - match               : '(0b)(?=[0-1])'
      scope               : constant.numeric.base.kdl
      push                :
      - meta_scope        : constant.numeric.integer.binary.kdl
      - meta_content_scope: constant.numeric.value.kdl
      - include           : â„¤â‚‚
  binaryâ„-:
    - match               : '(0b)(?=[0-1])'
      scope               : constant.numeric.base.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : constant.numeric.integer.binary.kdl
      - meta_content_scope: constant.numeric.value.kdl
      - include           : â„¤â‚‚â„-
  octal:                                          # Integer literal (octal)
    - match               : '(0o)(?=[0-7])'
      scope               : constant.numeric.base.kdl
      push                :
      - meta_scope        : constant.numeric.integer.octal.kdl
      - meta_content_scope: constant.numeric.value.kdl
      - include           : â„¤â‚ˆ
  octalâ„-:
    - match               : '(0o)(?=[0-7])'
      scope               : constant.numeric.base.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : constant.numeric.integer.octal.kdl
      - meta_content_scope: constant.numeric.value.kdl
      - include           : â„¤â‚ˆâ„-
  hexadecimal:                                    # Integer literal (hexadecimal)
    - match               : '(0x)(?=\h)'
      scope               : constant.numeric.base.kdl
      push                :
      - meta_scope        : constant.numeric.integer.hexadecimal.kdl
      - meta_content_scope: constant.numeric.value.kdl
      - include           : â„¤â‚â‚†
  hexadecimalâ„-:
    - match               : '(0x)(?=\h)'
      scope               : constant.numeric.base.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : constant.numeric.integer.hexadecimal.kdl
      - meta_content_scope: constant.numeric.value.kdl
      - include           : â„¤â‚â‚†â„-

  binÂ¦octÂ¦hex-partial:
    - include             : binary-partial
    - include             : octal-partial
    - include             : hexadecimal-partial
  binÂ¦octÂ¦hexâ„-partial:
    - include             : binaryâ„-partial
    - include             : octalâ„-partial
    - include             : hexadecimalâ„-partial
  binary-partial:
    - match               : '(0b)(?={{nl_s}})'
      scope               : constant.numeric.base.kdl
      push                :
      - meta_scope        : constant.numeric.integer.binary.kdl
      - include           : pop5
  binaryâ„-partial:
    - match               : '(0b)(?={{nl_s}})'
      scope               : constant.numeric.base.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : constant.numeric.integer.binary.kdl
      - include           : pop5
  octal-partial:
    - match               : '(0o)(?={{nl_s}})'
      scope               : constant.numeric.base.kdl
      push                :
      - meta_scope        : constant.numeric.integer.octal.kdl
      - include           : pop5
  octalâ„-partial:
    - match               : '(0o)(?={{nl_s}})'
      scope               : constant.numeric.base.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : constant.numeric.integer.octal.kdl
      - include           : pop5
  hexadecimal-partial:
    - match               : '(0x)(?={{nl_s}})'
      scope               : constant.numeric.base.kdl
      push                :
      - meta_scope        : constant.numeric.integer.hexadecimal.kdl
      - include           : pop5
  hexadecimalâ„-partial:
    - match               : '(0x)(?={{nl_s}})'
      scope               : constant.numeric.base.kdl comment.line.slash-dash.kdl
      push                :
      - meta_scope        : constant.numeric.integer.hexadecimal.kdl
      - include           : pop5

  # Values - Numbers (helpers) digitâ‚â‚€_
  # can't match repeatable group in a regex, so repeat a single digit match
  â„¤:
    - match               : '([0-9])' # leading zeros are allowed
      push                :
      - include           : digitâ‚â‚€_
      - include           : pop4
  â„¤â„-:
    - match               : '([0-9])'
      scope               : comment.line.slash-dash.kdl
      push                :
      - include           : digitâ‚â‚€_â„-
      - include           : pop4
  â„¤â‚‚:
    - match               : '([0-1])'
      push                :
      - include           : digitâ‚‚_
      - include           : pop4
  â„¤â‚‚â„-:
    - match               : '([0-1])'
      scope               : comment.line.slash-dash.kdl
      push                :
      - include           : digitâ‚‚_â„-
      - include           : pop4
  â„¤â‚ˆ:
    - match               : '([0-7])'
      push                :
      - include           : digitâ‚ˆ_
      - include           : pop4
  â„¤â‚ˆâ„-:
    - match               : '([0-7])'
      scope               : comment.line.slash-dash.kdl
      push                :
      - include           : digitâ‚ˆ_â„-
      - include           : pop4
  â„¤â‚â‚†:
    - match               : '(\h)'
      push                :
      - include           : digitâ‚â‚†_
      - include           : pop4
  â„¤â‚â‚†â„-:
    - match               : '(\h)'
      scope               : comment.line.slash-dash.kdl
      push                :
      - include           : digitâ‚â‚†_â„-
      - include           : pop4
  digitâ‚â‚€_:
    - match               : '(_)|([0-9])'
      captures            :
        1:                  punctuation.separator.number.kdl
  digitâ‚â‚€_â„-:
    - match               : '(_)|([0-9])'
      captures            :
        1:                  punctuation.separator.number.kdl comment.line.slash-dash.kdl
        2:                  comment.line.slash-dash.kdl
  digitâ‚‚_:
    - match               : '(_)|([0-1])'
      captures            :
        1:                  punctuation.separator.number.kdl
  digitâ‚‚_â„-:
    - match               : '(_)|([0-1])'
      captures            :
        1:                  punctuation.separator.number.kdl comment.line.slash-dash.kdl
        2:                  comment.line.slash-dash.kdl
  digitâ‚ˆ_:
    - match               : '(_)|([0-7])'
      captures            :
        1:                  punctuation.separator.number.kdl
  digitâ‚ˆ_â„-:
    - match               : '(_)|([0-7])'
      captures            :
        1:                  punctuation.separator.number.kdl comment.line.slash-dash.kdl
        2:                  comment.line.slash-dash.kdl
  digitâ‚â‚†_:
    - match               : '(_)|([0-9a-fA-F])'
      captures            :
        1:                  punctuation.separator.number.kdl
  digitâ‚â‚†_â„-:
    - match               : '(_)|([0-9a-fA-F])'
      captures            :
        1:                  punctuation.separator.number.kdl comment.line.slash-dash.kdl
        2:                  comment.line.slash-dash.kdl


#â€”â€”â€” 2 Node Element: 4 Child
  child_block:
    - match               : '{'
      scope               : punctuation.section.mapping.begin.kdl
      push                : child_block-body
  child_block1:
    - match               : '{'
      scope               : punctuation.section.mapping.begin.kdl
      push                : child_block1-body
  child_block4:
    - match               : '{'
      scope               : punctuation.section.mapping.begin.kdl #âœ—chblock4
      push                : child_block4-body
  child_blockâ„-:
    - match               : '{'
      scope               : punctuation.section.mapping.begin.kdl comment.line.slash-dash.kdl
      push                : child_block-bodyâ„-
  child_block1â„-:
    - match               : '{'
      scope               : punctuation.section.mapping.begin.kdl comment.line.slash-dash.kdl
      push                : child_block1-bodyâ„-
  child_block4â„-:
    - match               : '{'
      scope               : punctuation.section.mapping.begin.kdl comment.line.slash-dash.kdl
      push                : child_block4-bodyâ„-
  child_block-body:
    - meta_scope          : meta.block.child.kdl
    - include             : wss
    - include             : comment_line_noâ¤
    - match               : '}'
    # - match               : '}|(?<=})' # alternative to hunting down space} to highlight the missing ;
    # - match               : '}|(?!{{nl_s}})(?<=})' # better alternative to avoid end} breaking next }
      scope               : punctuation.section.mapping.end.kdl
      pop                 : 3
      push                :
      - include           : wss
      - include           : node_terminator3
      - include           : SğŸ›‘Â¹preâ¤
    - match               : '(?=\S)'
      push                : nodes
  child_block1-body:
    - meta_scope          : meta.block.child.kdl
    - include             : wss
    - include             : comment_line_noâ¤
    - match               : '}'
    # - match               : '}|(?!{{nl_s}})(?<=})' # alternative to hunting down space} to highlight the missing ;
      scope               : punctuation.section.mapping.end.kdl
      pop                 : 2
      push                :
      - include           : wss
      - include           : node_terminator3
      - include           : SğŸ›‘Â¹preâ¤
    - match               : '(?=\S)'
      push                : nodes
  child_block4-body:
    - meta_scope          : meta.block.child.kdl #âœ—chblock4_body
    - include             : wss
    - include             : comment_line_noâ¤
    - match               : '}'
    # - match               : '}|(?!{{nl_s}})(?<=})' # alternative to hunting down space} to highlight the missing ;
      scope               : punctuation.section.mapping.end.kdl
      pop                 : 3
      push                :
      - include           : wss
      - include           : node_terminator4
      - include           : SğŸ›‘Â¹preâ¤
    - match               : '(?=\S)'
      push                : nodes
  child_block-bodyâ„-:
    - meta_scope          : meta.block.child.kdl
    - include             : wss
    - include             : comment_line_noâ¤
    - match               : '}'
    # - match               : '}|(?!{{nl_s}})(?<=})' # alternative to hunting down space} to highlight the missing ;
      scope               : punctuation.section.mapping.end.kdl
      pop                 : 3
      push                :
      - include           : wss
      - include           : node_terminator3â„-
      - include           : SğŸ›‘Â¹preâ¤
    - match               : '(?=\S)'
      push                : nodesâ„-
  child_block1-bodyâ„-:
    - meta_scope          : meta.block.child.kdl
    - include             : wss
    - include             : comment_line_noâ¤
    - match               : '}'
    # - match               : '}|(?!{{nl_s}})(?<=})' # alternative to hunting down space} to highlight the missing ;
      scope               : punctuation.section.mapping.end.kdl
      pop                 : 2
      push                :
      - include           : wss
      - include           : node_terminator3â„-
      - include           : SğŸ›‘Â¹preâ¤
    - match               : '(?=\S)'
      push                : nodesâ„-
  child_block4-bodyâ„-:
    - meta_scope          : meta.block.child.kdl
    - include             : wss
    - include             : comment_line_noâ¤
    - match               : '}'
    # - match               : '}|(?!{{nl_s}})(?<=})' # alternative to hunting down space} to highlight the missing ;
      scope               : punctuation.section.mapping.end.kdl
      pop                 : 3
      push                :
      - include           : wss
      - include           : node_terminator4â„-
      - include           : SğŸ›‘Â¹preâ¤
    - match               : '(?=\S)'
      push                : nodesâ„-


#â€”â€”â€” 2 Node Element: 5 End
  node_terminator:        # â‰ node-terminator : single-line-comment | newline | ";" | eof
    - include             : comment_line
    - include             : â¤
    - include             : eof
    # - include             : popï½
    - match               : ;
      scope               : punctuation.terminator.node.kdl
      pop                 : 1
    - include             : ï½ğŸ›‘
  node_terminatorğŸ›‘2:
    - include             : comment_lineğŸ›‘2
    - include             : â¤ğŸ›‘2
    # - include             : eof
    - match               : ;
      scope               : invalid.illegal.position.kdl
      pop                 : 2
    - include             : ï½ğŸ›‘2
  node_terminatorğŸ›‘3:
    - include             : comment_lineğŸ›‘3
    - include             : â¤ğŸ›‘3
    # - include             : eof
    - match               : ;
      scope               : invalid.illegal.position.kdl
      pop                 : 3
    - include             : ï½ğŸ›‘3
  node_terminatorâ„-:
    - include             : comment_lineâ„-
    - include             : â¤
    - include             : eof
    # - include             : popï½
    - match               : ;
      scope               : punctuation.terminator.node.kdl comment.line.slash-dash.kdl
      pop                 : 1
    - include             : ï½ğŸ›‘
  node_terminator2:       # X pops to allow the convenience of earlier pushes to e.g. track node level and ensure arguments have mandatory ws
    - include             : comment_line2_term
    - include             : â¤term2
    - include             : eof2
    - match               : ;
      scope               : punctuation.terminator.node.kdl
      pop                 : 2
    - include             : ï½ğŸ›‘2
  node_terminator2â„-:
    - include             : comment_line2_termâ„-
    - include             : â¤term2
    - include             : eof2
    - match               : ;
      scope               : punctuation.terminator.node.kdl comment.line.slash-dash.kdl
      pop                 : 2
    - include             : ï½ğŸ›‘2
  node_terminator3:
    - include             : comment_line3_term
    - include             : â¤term3
    - include             : eof3
    - match               : ;
      scope               : punctuation.terminator.node.kdl
      pop                 : 3
    - include             : ï½ğŸ›‘3
  node_terminator3â„-:
    - include             : comment_line3_termâ„-
    - include             : â¤term3
    - include             : eof3
    - match               : ;
      scope               : punctuation.terminator.node.kdl comment.line.slash-dash.kdl #âœ—n_term3â„â€“
      pop                 : 3
    - include             : ï½ğŸ›‘3
  node_terminator4:
    - include             : comment_line4_term
    - include             : â¤term4
    - include             : eof4
    - match               : ;
      scope               : punctuation.terminator.node.kdl
      pop                 : 4
    - include             : ï½ğŸ›‘4
  node_terminator4â„-:
    - include             : comment_line4_termâ„-
    - include             : â¤term4
    - include             : eof4
    - match               : ;
      scope               : punctuation.terminator.node.kdl comment.line.slash-dash.kdl
      pop                 : 4
    - include             : ï½ğŸ›‘4

  preï½ğŸ›‘:                # missing node terminator before }, requires hunting down for space before }, which nodespace or other rule can handle already
    - match               : '{{b_sp}}*?({{b_sp}})?(?=\})'
      captures            :
        1:                  invalid.illegal.kdl
      pop                 : 1
  ï½ğŸ›‘:
    - match               : \}
      scope               : punctuation.section.mapping.end.kdl invalid.illegal.position.kdl #âœ—ï½ğŸ›‘
      pop                 : 1
  ï½ğŸ›‘2:
    - match               : \}
      scope               : punctuation.section.mapping.end.kdl invalid.illegal.position.kdl #âœ—ï½ğŸ›‘2
      pop                 : 2
  ï½ğŸ›‘3:
    - match               : \}
      scope               : punctuation.section.mapping.end.kdl invalid.illegal.position.kdl #âœ—ï½ğŸ›‘3
      pop                 : 3
      push                :
      - include           : wss
      - include           : node_terminator3
      - include           : SğŸ›‘Â¹preâ¤

  ï½ğŸ›‘4:
    - match               : \}
      scope               : punctuation.section.mapping.end.kdl invalid.illegal.position.kdl #âœ—ï½ğŸ›‘4
      pop                 : 4
      push                :
      - include           : wss
      - include           : node_terminator3
      - include           : SğŸ›‘Â¹preâ¤
  ï½:
    - match               : '(?=\})'
      pop                 : 1
  ï½2:
    - match               : '(?=\})'
      pop                 : 2
  ï½3:
    - match               : '(?=\})'
      pop                 : 3
  ï½4:
    - match               : '(?=\})'
      pop                 : 4

  line_continuation:      # â‰ escline = \ ws* (single-line-comment     | newline)
                          #                  =â†‘single-line-comment_no_nl newline
    - match               : \\
      scope               : punctuation.separator.continuation.line.kdl #âœ—lc
      push                : line_continuation-line1
  line_continuationâ„-:
    - match               : \\
      scope               : punctuation.separator.continuation.line.kdl comment.line.slash-dash.kdl #âœ—lcâ„â€“
      push                : line_continuationâ„-line1
  line_continuations:
    - match               : \\
      scope               : punctuation.separator.continuation.line.kdl #âœ—lcs
      push                : line_continuations-line1
  line_continuation-line1:
    - include             : wss                         # â‰ ... ws*
    - include             : comment_line_noâ¤           # â‰ ... single-line-comment (without newline, so â†“ captures)
    - match               : '({{nl_s}})'                # â‰ ... newline
      #scope               : dbgâœ—line_continuation-line1
      set                 : line_continuation-line_next
    - include             : SğŸ›‘s
  line_continuationâ„-line1:
    - include             : wss                         # â‰ ... ws*
    - include             : comment_line_noâ¤           # â‰ ... single-line-comment (without newline, so â†“ captures)
    - match               : '({{nl_s}})'                # â‰ ... newline
      set                 : line_continuationâ„-line_next
    - include             : SğŸ›‘s
  line_continuations-line1:
    #- meta_scope          : dbgâœ—line_continuations-line1
    # - include             : keyword-partial
    - include             : wss
    - include             : comment_line_noâ¤
    - match               : '({{nl_s}})'
      set                 : line_continuations-line_next
    - include             : SğŸ›‘s
  line_continuation-line_next:
    - include             : wss
    - include             : comment_line_noâ¤
    - include             : â¤ğŸ›‘
    - match               : \\                          # disallows repeated
      scope               : punctuation.separator.continuation.line.kdl invalid.illegal.position.kdl
      # pop                 : 1                         # disallows 2nd \, but not 3rd+
    - include             : else-pop
    # - include             : else-pop2                   # 2 disallows repeated \, but requires extra push before use
  line_continuationâ„-line_next:
    - include             : wss
    - include             : comment_line_noâ¤
    - include             : â¤ğŸ›‘
    - match               : \\                          # disallows repeated
      scope               : punctuation.separator.continuation.line.kdl invalid.illegal.position.kdl comment.line.slash-dash.kdl
    - include             : else-pop
  line_continuations-line_next:
    - include             : wss
    - include             : comment_lines_noâ¤
    - include             : â¤ğŸ›‘s # todo: change to 1
    - include             : else-pop


#â€”â€”â€” Comments
  comment_block_doc       :                       # Block documentation comment
    - match               : '({{comment_block_doc_beg}})'
      scope               : punctuation.definition.comment.begin.kdl
      push                :
      - meta_scope        : comment.block.documentation.kdl
      - match             : '{{comment_block_end}}'
        scope             : punctuation.definition.comment.end.kdl
        pop               : 1
      - include           : comment_block_doc
      - include           : comment_block
  comment_block           :                       # Block comment
    - match               : '({{comment_block_beg}})'
      scope               : punctuation.definition.comment.begin.kdl
      push                :
      - meta_scope        : comment.block.kdl
      - match             : '{{comment_block_end}}'
        scope             : punctuation.definition.comment.end.kdl
        pop               : 1
      - include           : comment_block_doc
      - include           : comment_block
  comment_line:                                   # Single-line comment
    - match               : // # better than {{single_line_comment}} as doesn't consume the whole line and allows embedding with early popping
      scope               : punctuation.definition.comment.begin.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $({{newline}})? # consume â¤ not to show completions when typing comments
          pop             : 2
          captures        :
            1:              punctuation.definition.comment.end.kdl
  comment_lineğŸ›‘:
    - match               : //
      scope               : invalid.illegal.position.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $({{newline}})?
          pop             : 2
          captures        :
            1:              punctuation.definition.comment.end.kdl
  comment_lineğŸ›‘2:
    - match               : //
      scope               : invalid.illegal.position.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $({{newline}})?
          pop             : 3
          captures        :
            1:              punctuation.definition.comment.end.kdl
  comment_lineğŸ›‘3:
    - match               : //
      scope               : invalid.illegal.position.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $({{newline}})?
          pop             : 4
          captures        :
            1:              punctuation.definition.comment.end.kdl
  comment_line2_term:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl punctuation.terminator.node.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $({{newline}})?
          pop             : 3
          captures        :
            1:              punctuation.definition.comment.end.kdl
  comment_line3_term:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl punctuation.terminator.node.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $({{newline}})?
          pop             : 4
          captures        :
            1:              punctuation.definition.comment.end.kdl
  comment_line4_term:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl punctuation.terminator.node.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $({{newline}})?
          pop             : 5
          captures        :
            1:              punctuation.definition.comment.end.kdl
  comment_lineâ„-:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl comment.line.slash-dash.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl comment.line.slash-dash.kdl
        - match           : $({{newline}})?
          pop             : 2
          captures        :
            1:              punctuation.definition.comment.end.kdl comment.line.slash-dash.kdl
  comment_line2_termâ„-:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl punctuation.terminator.node.kdl comment.line.slash-dash.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl comment.line.slash-dash.kdl
        - match           : $({{newline}})?
          pop             : 4
          captures        :
            1:              punctuation.definition.comment.end.kdl comment.line.slash-dash.kdl
  comment_line3_termâ„-:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl punctuation.terminator.node.kdl comment.line.slash-dash.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl comment.line.slash-dash.kdl
        - match           : $({{newline}})?
          pop             : 4
          captures        :
            1:              punctuation.definition.comment.end.kdl punctuation.terminator.node.kdl comment.line.slash-dash.kdl
  comment_line4_termâ„-:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl comment.line.slash-dash.kdl
      push                :
        - meta_scope      : comment.line.double-slash.kdl comment.line.slash-dash.kdl
        - match           : $({{newline}})?
          pop             : 5
          captures        :
            1:              punctuation.definition.comment.end.kdl comment.line.slash-dash.kdl
  comment_line_noâ¤:                             # Single-line comment without capturing ending â¤
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl #âœ—cline_noâ¤
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $
          pop             : 1
  comment_line2_noâ¤:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl #âœ—cline_noâ¤
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $
          pop             : 2
  comment_lines_noâ¤:
    - match               : //
      scope               : punctuation.definition.comment.begin.kdl #âœ—cline_noâ¤
      push                :
        - meta_scope      : comment.line.double-slash.kdl
        - match           : $
          pop             : 1

# Primitives, with some ~matching KDL Spec elements
  linesp:                 # â‰ linespace : newline | ws | single-line-comment
    - include             : â¤
    - include             : ws
    - include             : comment_line #todo: bugs with } on a line after //
    # - include             : comment_line_noâ¤
  â¤s:
    - match               : '{{newline}}'
      #scope               : dbgâœ—â¤s
  â¤:
    - match               : '{{newline}}'
      #scope               : dbgâœ—â¤
      pop                 : 1
  â¤term2:
    - match               : '{{newline}}'
      scope               : punctuation.terminator.node.kdl #âœ—â¤2
      pop                 : 2
  â¤term3:
    - match               : '{{newline}}'
      scope               : punctuation.terminator.node.kdl #âœ—â¤3
      pop                 : 3
  â¤term4:
    - match               : '{{newline}}'
      scope               : punctuation.terminator.node.kdl #âœ—â¤4
      pop                 : 4
  eof:
    - match               : '{{eof}}'
      #scope               : dbgâœ—eof
      pop                 : 1
  eof2:
    - match               : '{{eof}}'
      #scope               : dbgâœ—eof
      pop                 : 2
  eof3:
    - match               : '{{eof}}'
      #scope               : dbgâœ—eof
      pop                 : 3
  eof4:
    - match               : '{{eof}}'
      #scope               : dbgâœ—eof
      pop                 : 4

  ws:                     # â‰ bom | unicode-space | multi-line-comment
    - include             : bom
    - include             : u_sp
    - include             : comment_blockâˆ¨doc
  wss:
    - include             : boms
    - include             : u_sps
    - include             : comment_blockâˆ¨doc
  bom:
    - match               : '{{bom}}'
      #scope               : dbgâœ—bom
      pop                 : 1
  boms:
    - match               : '{{bom}}'
      #scope               : dbgâœ—boms
  u_sp:
    - match               : '{{u_sp}}'
      #scope               : dbgâœ—â 
      pop                 : 1
  u_sps:
    - match               : '{{u_sp}}'
      #scope               : dbgâœ—â s
  b_sp:
    - match               : '{{b_sp}}'
      #scope               : dbgâœ—bâ 
      pop                 : 1
  b_sps:
    - match               : '{{b_sp}}'
      #scope               : dbgâœ—bâ s

  nodeâ :                 # â‰ node-space: ws* escline ws* | ws+
    - include             : line_continuation
    - include             : ws+âˆ¨ws-lineâ‹-ws
  nodeâ s:
    - include             : line_continuations
    - include             : wss # todo: don't need branching?
  nodeâ â„-:                #
    - include             : line_continuationâ„-
    - include             : ws+âˆ¨ws-lineâ‹-ws
  ws+âˆ¨ws-lineâ‹-ws:
    - match               : '(?={{ws_beg}})'
      branch_point        : â¸™ws+âˆ¨ws-lineâ‹-ws
      branch              :
        - ws+â¸™1
        - ws-lineâ‹-wsâ¸™1
  ws+âˆ¨ws-lineâ‹-wsâ„-:
    - match               : '(?={{ws_beg}})'
      branch_point        : â¸™ws+âˆ¨ws-lineâ‹-wsâ„-
      branch              :
        - ws+â„-â¸™1
        - ws-lineâ‹-wsâ„-â¸™1
  ws+â¸™1:
    #- meta_scope          : dbgâœ—nodeâ _ws+âˆ¨ws-lineâ‹-ws_ws+â¸™1
    - match               : '(?={{escline_beg}})'
      fail                : â¸™ws+âˆ¨ws-lineâ‹-ws
    - include             : wss
    - include             : popâ¸™
    # - meta_scope          : âœ—ws+â¸™1
    # - match               : '{{b_sp}}'
      # scope               : bspâœ—ws+â¸™1
    # - include             : comment_blockâˆ¨doc
    # - include             : node-elements
    # - match               : '(?={{ws_beg}})'
      # push                :
      # - include           : ws-pop2
    # - include             : anyğŸ›‘
  ws+â„-â¸™1:
    - match               : '(?={{escline_beg}})'
      fail                : â¸™ws+âˆ¨ws-lineâ‹-wsâ„-
    - include             : wss
    - include             : popâ¸™
  ws-lineâ‹-wsâ¸™1:
    - include             : wss
    - include             : line_continuation
    - include             : popâ¸™
    # - meta_scope          : âœ—ws-lineâ‹-wsâ¸™1
    # - match               : '{{b_sp}}'
    #   scope               : bspâœ—ws-lineâ‹-wsâ¸™1
    # - include             : comment_blockâˆ¨doc
  ws-lineâ‹-wsâ„-â¸™1:
    - include             : wss
    - include             : line_continuationâ„-
    - include             : popâ¸™
  nodeâ +:
    - include             : nodeâ 
    - include             : anyğŸ›‘



# Various helpers
  â¤ğŸ›‘s:
    - match               : '{{nl_s}}'
      scope               : invalid.illegal.position.kdl #âœ—delnl
  â¤ğŸ›‘:
    - match               : '{{nl_s}}'
      scope               : invalid.illegal.position.kdl #âœ—delnl1
      pop                 : 1
  â¤ğŸ›‘2:
    - match               : '{{nl_s}}'
      scope               : invalid.illegal.position.kdl #âœ—delnl2
      pop                 : 2
  â¤ğŸ›‘3:
    - match               : '{{nl_s}}'
      scope               : invalid.illegal.position.kdl #âœ—delnl3
      pop                 : 3
  â¤ğŸ›‘Â¹s:                 # make only the first contiguous â¤ red
    - match               : '({{nl_s}})'
      scope               : invalid.illegal.position.kdl #âœ—1
      push                :
      - match             : '({{nl_s}})'
        scope             : invalid.illegal.muted.position.kdl #âœ—1b
      - include           : else-pop
  anyğŸ›‘s:
    - match               : '[\S\s]'
      scope               : invalid.illegal.position.kdl #âœ—DelAnyğŸ›‘s
  anyğŸ›‘:
    - match               : '[\S\s]'
      scope               : invalid.illegal.position.kdl #âœ—DelAnyğŸ›‘
      pop                 : 1
  sğŸ›‘Â¹:                   # make only the first contiguous \s red
    - match               : '(\s)'
      scope               : invalid.illegal.position.kdl #âœ—sğŸ›‘Â¹s
      push                :
      - match             : '(\s)'
        scope             : invalid.illegal.muted.position.kdl #âœ—sğŸ›‘Â¹s
        pop               : 2    # bail out after 2nd space
      - include           : pop2 # bail out after 1st space
  sğŸ›‘Â¹s:                  # make only the first contiguous \s red
    - match               : '(\s)'
      scope               : invalid.illegal.position.kdl #âœ—sğŸ›‘Â¹s
      push                :
      - match             : '(\s)'
        scope             : invalid.illegal.muted.position.kdl #âœ—sğŸ›‘Â¹s
      - include           : pop # repeat 2nd space
  bspğŸ›‘Â¹s:                  # make only the first contiguous b_sp red
    - match               : '({{b_sp}})'
      scope               : invalid.illegal.position.kdl #âœ—bspğŸ›‘Â¹s
      push                :
      - match             : '({{b_sp}})'
        scope             : invalid.illegal.muted.position.kdl #âœ—bspğŸ›‘Â¹s
      - include           : pop # repeat 2nd space
  sğŸ›‘s:
    - match               : '(\s)'
      scope               : invalid.illegal.position.kdl #âœ—2
  sğŸ›‘:
    - match               : '(\s)'
      scope               : invalid.illegal.position.kdl #âœ—3
    - include             : else-pop
  SğŸ›‘s:
    - match               : '(\S)'
      scope               : invalid.illegal.position.kdl #âœ—SğŸ›‘
  SğŸ›‘:
    - match               : '(\S)'
      scope               : invalid.illegal.position.kdl #âœ—SğŸ›‘
      pop                 : 1
  SğŸ›‘preâ :               # mark without red highlight
    - match               : '(\S*)(?={{b_sp}})'
      captures            :
        2:                  invalid.illegal.muted.position.kdl #âœ—SğŸ›‘preâ 
  chğŸ›‘preâ :              # to avoid red flashes, mark last char as illegal before â 
    - match               : '({{charID}}*)({{charID}})(?={{b_sp}})'
      captures            :
        1:                  invalid.illegal.muted.position.kdl #âœ—chğŸ›‘preâ 
        2:                  invalid.illegal.position.kdl #âœ—chğŸ›‘preâ 
  chğŸ›‘pre-str:
    - match               : '({{charID}}*?)({{charID}})(?={{string_beg}})'
      captures            :
        1:                  invalid.illegal.muted.position.kdl #âœ—chğŸ›‘pre-str
        2:                  invalid.illegal.position.kdl #âœ—chğŸ›‘pre-str
  chğŸ›‘pre_term:           # to avoid red flashes, mark last char as illegal before node terminator
    - match               : '({{charID}}*)({{charID}})(?={{node_term_beg_no_nl}})'
      captures            :
        1:                  invalid.illegal.muted.position.kdl #âœ—chğŸ›‘pre_term
        2:                  invalid.illegal.position.kdl #âœ—chğŸ›‘pre_term
  SğŸ›‘preâ¤:               # to avoid red flashes, mark as invalid, not illegal
    - match               : '(\S*)(\S)(?=\n)'
      captures            :
        1:                  invalid.illegal.muted.position.kdl
        2:                  invalid.illegal.muted.position.kdl
  SğŸ›‘Â¹preâ¤:              # make only the first char before â¤ red
    - match               : '(\S)'
      scope               : invalid.illegal.position.kdl #âœ—SğŸ›‘Â¹preâ¤
      push                :
      - include           : pop_preâ¤
      - match             : '(\S)'
        scope             : invalid.illegal.muted.position.kdl #âœ—SğŸ›‘Â¹preâ¤
  SğŸ›‘Â¹pre_ws:             # ... â  â¤
    - match               : '(\S)'
      scope               : invalid.illegal.position.kdl #âœ—SğŸ›‘Â¹preâ¤
      push                :
      - include           : pop_preâ 
      - include           : pop_preâ¤
      - match             : '(\S)'
        scope             : invalid.illegal.muted.position.kdl #âœ—SğŸ›‘Â¹preâ¤
  SğŸ›‘Â¹pre_sâˆ¨câˆ¨t:          # ... child start or node terminator or ws
    - match               : '(\S)'
      scope               : invalid.illegal.position.kdl #âœ—SğŸ›‘Â¹pre_sâˆ¨câˆ¨t
      push                :
      - include           : pop_pre-ch
      - include           : pop_pre-term
      - include           : pop_pre-nodeâ 
      - match             : '(\S)'
        scope             : invalid.illegal.muted.position.kdl #âœ—SğŸ›‘Â¹pre_sâˆ¨câˆ¨t


  charğŸ†”Â¬:
    - match               : '{{charID_not}}'
      scope               : invalid.illegal.kdl #âœ—chID
  pop_preâ :
    - match               : '(?={{b_sp}})'
      pop                 : 1
  pop_pre-ch:
    - match               : '(?=\{)'
      pop                 : 1
  pop_pre-term:
    - match               : '(?={{node_term_beg}})'
      pop                 : 1
  pop_preâ¤:
    - match               : '(?={{nl_s}})'
      pop                 : 1
  pop_pre-nodeâ :
    - match               : '(?={{node_sp_beg}})'
      pop                 : 1
  pop_preğŸ†”Â¬:
    - match               : '(?={{charID_not}})'
      pop                 : 1
  pop_pre-ws:
    - match               : '(?={{ws_beg}})'
      pop                 : 1
  pop_pre-str:
    - match               : '(?=\"|r\")'
      pop                 :
  pop2_preâ :
    - match               : '(?={{b_sp}})'
      pop                 : 2
  pop2_pre-ch:
    - match               : '(?=\{)'
      pop                 : 2
  pop2_pre-term:
    - match               : '(?={{node_term_beg}})'
      pop                 : 2
  pop3_pre-term:
    - match               : '(?={{node_term_beg}})'
      pop                 : 3
  pop2_preâ¤:
    - match               : '(?={{nl_s}})'
      pop                 : 2
  pop2_pre-nodeâ :
    - match               : '(?={{node_sp_beg}})'
      pop                 : 2
  pop2_pre-str:
    - match               : '(?=\"|r\")'
      pop                 : 2
  pop2_preğŸ†”Â¬:
    - match               : '(?={{charID_not}})'
      pop                 : 2
  pop2_pre-ws:
    - match               : '(?={{ws_beg}})'
      pop                 : 2
  pop3_pre-str:
    - match               : '(?=\"|r\")'
      pop                 : 3
  pop_preï¼‰:
    - match               : (?=\))
      pop                 : 1
  pop2_preï¼‰:
    - match               : (?=\))
      pop                 : 2

  else-pop:               # pop_pre-non_ws
    - match               : '(?=\S)'
      pop                 : 1
  else-pop2:
    - match               : '(?=\S)'
      pop                 : 2
  else-pop3:
    - match               : '(?=\S)'
      pop                 : 3
  pop:
    - match               : ''
      pop                 : 1
  pop2:
    - match               : ''
      pop                 : 2
  pop3:
    - match               : ''
      pop                 : 3
  pop4:
    - match               : ''
      pop                 : 4
  pop5:
    - match               : ''
      pop                 : 5
  popâ¸™:
    - include             : pop
  pop2â¸™:
    - include             : pop2
  pop3â¸™:
    - include             : pop3


# Whitespace (Line breaking)
  #  Acronym	Name                         	Code Pt 	Oniguruma
  #  CRLF   	Carriage Return and Line Feed	   D + A	\r\n
  #  CR     	Carriage Return              	   D    	\r
  #  LF     	Line Feed                    	   A    	\n (newline)
  #âœ— VT     	Vertical Tabulation          	   B    	\v
  #  FF     	Form Feed                    	   C    	\f
  #  NEL    	Next Line                    	  85    	â€¯
  #  LS     	Line Separator               	2028    	â€¯
  #  PS     	Paragraph Separator          	2029    	â€¯
  # âˆ‘= d+a d a c   85 2028 2029 (KDL)
  # âˆ‘= d+a d a c b 85 2028 2029 (oniguruma) \R: \r\n or \r \n \v \f 85 2028 2029 (!!! can't be used in a character class !!!)
  #             \v vertical tab is excluded from KDL
  # Sublime only works with: (?>\R), equiv= (?>\r\n?|[\x{A}-\x{C}\x{85}\x{2028}\x{2029}])
  # (?>â€¦) â€” Matches the provided pattern, but no backtracking is performed if the match fails
  # \b           backspace               8
  # \a           bell                    7
  # \e           escape                 1B

# Whitespace (non-Newline)
  # Acronym	Name                     	Code Pt	Oniguruma
  #        	Character Tabulation     	   9   	\t (horizontal tab)
  #        	Space                    	  20   	.
  #        	No-Break Space           	  A0   	.
  #        	Ogham Space Mark         	1680   	.
  #        	En Quad                  	2000   	.
  #        	Em Quad                  	2001   	.
  #        	En Space                 	2002   	.
  #        	Em Space                 	2003   	.
  #        	Three-Per-Em Space       	2004   	.
  #        	Four-Per-Em Space        	2005   	.
  #        	Six-Per-Em Space         	2006   	.
  #        	Figure Space             	2007   	.
  #        	Punctuation Space        	2008   	.
  #        	Thin Space               	2009   	.
  #        	Hair Space               	200A   	.
  #        	Narrow No-Break Space    	202F   	.
  #        	Medium Mathematical Space	205F   	.
  #        	Ideographic Space        	3000   	.
  # âˆ‘=                 9 20 A0 1680 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 200A 202F 205F 3000
  # \s 85(nel) a b c d 9 Line_Separator Paragraph_Separator Space_Separator (oniguruma)
    # Space_Separator    20 A0 1680 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 200A 202F 205F 3000
    # Line_Separator      2028
    # Paragraph_Separator	2029
    # https://www.compart.com/en/unicode/category/Zl
    # https://www.compart.com/en/unicode/category/Zs
    # https://www.compart.com/en/unicode/category/Zp
    # [^\S\r\n] double negative to match whitespace without newline (but add other newlines)
      # [^\S(?>\R)] seems to work
      # \S character NOT
        # 9 a b c d 85
        # Line_Separator      2028
        # Paragraph_Separator 2029
        # Space_Separator 20 A0 1680 2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 200A 202F 205F 3000
